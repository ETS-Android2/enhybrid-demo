#!/usr/bin/env node

module.exports = function(ctx) {
  var shell = require('shelljs');
  var path = require('path');
  var fs = require('fs-extra');
  var ConfigParser = ctx.requireCordovaModule('cordova-common').ConfigParser,  
      config = new ConfigParser(path.join(ctx.opts.projectRoot, "config.xml")), 
      packageName = config.android_packageName() || config.packageName();

  try {
    var envApplicationToEditor = path.join(ctx.opts.projectRoot, '/platforms/android/app/src/main/java/com/envisioncn/cordova/hybridInit/EnvApplication.java');
    writeAlternativeContentSync(fs, envApplicationToEditor, /(\/\/ IMPORT START)([\s\S]*\/\/ IMPORT END)/, 'import', 'import com.envisioncn.cordova.language.LocaleManager;');
    writeAlternativeContentSync(fs, envApplicationToEditor, /(\/\/ ONCREATE START)([\s\S]*\/\/ ONCREATE END)/, 'oncreate', 'LocaleManager.initDefaultLocale(this);');
    writeAlternativeContentSync(fs, envApplicationToEditor, /(\/\/ ONCONFIGURATIONCHANGED START)([\s\S]*\/\/ ONCONFIGURATIONCHANGED END)/, 'onconfigurationchanged', 'LocaleManager.configLocale(this, LocaleManager.getUserLocale(this));');
    var baseWebViewActivityToEditor = path.join(ctx.opts.projectRoot, '/platforms/android/app/src/main/java/com/envisioncn/cordova/webContainer/EnvBaseWebViewActivity.java');
    writeAlternativeContentSync(fs, baseWebViewActivityToEditor, /(\/\/ IMPORT START)([\s\S]*\/\/ IMPORT END)/, 'import', 'import com.envisioncn.cordova.language.LocaleManager;');
    writeAlternativeContentSync(fs, baseWebViewActivityToEditor, /(\/\/ ADD COOKIES START)([\s\S]*\/\/ ADD COOKIES END)/, 'add cookies', 'CookieSyncUtils.syncCookie(this, url, LocaleManager.getCurrentLocaleCookie(this));');
  } catch (err) {
    console.log(err);
  }
}

function writeAlternativeContentSync(fs, file, regularStr, key, content){
  var addContent = '// mobile-plugin-language ' + key + ' start\n' + content + '\n// mobile-plugin-language ' + key + ' end'
  var readFileData = fs.readFileSync(file, 'utf8');
  readFileData = readFileData.replace(regularStr, '$1\n' + addContent + '$2');
  fs.writeFileSync(file, readFileData);
}
